<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div class="chat-container">
    <div id="header">
      Chat Room <span id="online"></span>
    </div>
    <div class="messages" id="messages"></div>
    <form id="form" class="form">
      <input id="input" autocomplete="off" placeholder="Type a message..." />
      <button type="submit" class="send-btn">Send</button>
    </form>
  </div>

  <script>
    const socket = io();
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    const online = document.getElementById('online');

    const clientId = Math.random().toString(36).substring(2, 9);

    function formatTime(ts) {
      const d = new Date(ts * 1000);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function renderMessage(msg) {
      let div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.client_id === clientId ? 'mine' : 'theirs');

      // Check for standalone emoji
      const isEmoji = /^[\p{Emoji}\u200d]+$/u.test(msg.text.trim());

      div.innerHTML = `
        <div class="text ${isEmoji ? 'emoji-big' : ''}">${msg.text}</div>
        <div class="meta">
          <span class="time">${formatTime(msg.timestamp)}</span>
          ${msg.client_id === clientId ? 
            `<span class="status">
              ${msg.status === 'sent' ? '✓' : 
                msg.status === 'received' ? '✓✓' : 
                msg.status === 'read' ? '<span style="color:#007aff">✓✓</span>' : ''}
            </span>` : ''
          }
        </div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // Send message
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (input.value) {
        socket.emit("send_message", { client_id: clientId, text: input.value });
        input.value = "";
      }
    });

    // Load old messages
    socket.on("chat_history", (history) => {
      messages.innerHTML = "";
      history.forEach(renderMessage);
    });

    // New incoming message
    socket.on("new_message", (msg) => {
      renderMessage(msg);
      if (msg.client_id !== clientId) {
        socket.emit("message_received", { message_id: msg.id });
        // auto-mark as read for demo
        socket.emit("message_read", { message_id: msg.id });
      }
    });

    // Update read receipts
    socket.on("message_status", (data) => {
      let last = messages.querySelectorAll('.mine .status');
      if (last.length > 0) {
        let el = last[last.length - 1];
        if (data.status === "received") el.textContent = "✓✓";
        if (data.status === "read") el.innerHTML = '<span style="color:#007aff">✓✓</span>';
      }
    });

    // Online status
    socket.on("online_status", (data) => {
      online.textContent = data.status;
    });
  </script>
</body>
</html>
