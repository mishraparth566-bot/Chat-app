<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
  <div class="chat-container">
    <div id="status-bar">Online</div>
    <div id="chat-box"></div>
    <div class="input-area">
      <input type="text" id="message" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const socket = io();
    const chatBox = document.getElementById('chat-box');
    const msgInput = document.getElementById('message');
    const sendBtn = document.getElementById('sendBtn');

    function renderMessage(data, self=false) {
      let isEmojiOnly = /^[\p{Emoji}\u200d]+$/u.test(data.msg);

      const div = document.createElement('div');
      div.classList.add('message', self ? 'sent' : 'received');

      let bubble = `
        <div class="bubble ${isEmojiOnly ? 'emoji-only' : ''}">
          ${data.msg}
          <span class="timestamp">${data.timestamp}
            ${self ? '<span class="ticks">âœ“</span>' : ''}
          </span>
        </div>
      `;
      div.innerHTML = bubble;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on('chat_history', (history) => {
      chatBox.innerHTML = "";
      history.forEach(msg => {
        renderMessage(msg, msg.username === socket.id);
      });
    });

    socket.on('receive_message', (data) => {
      renderMessage(data, data.username === socket.id);
    });

    sendBtn.onclick = () => {
      let msg = msgInput.value.trim();
      if (msg) {
        socket.emit('send_message', { msg: msg, username: socket.id });
        msgInput.value = "";
      }
    };

    socket.on('status', (data) => {
      document.getElementById('status-bar').innerText = data.msg;
    });
  </script>
</body>
</html>
